<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La roulette des secrets - Jeu d'équipe</title>
    <style>
        /* Styles existants... */
    </style>
</head>
<body>
    <!-- Logo EF Education First -->
    <img id="logo" src="EF-Logo-Sans-Fond.png" alt="EF Education First Logo">

    <!-- Bannière dynamique -->
    <div id="banner"><span id="bannerText">Bienvenue sur La roulette des secrets !</span></div>

    <!-- Bouton Admin -->
    <button id="adminButton" onclick="toggleAdminPopup()">Admin</button>
    <div id="adminPopup">
        <a href="edit.html" target="_blank">Éditer les valeurs</a>
        <a href="edit_banner.html" target="_blank">Modifier la bannière</a>
        <a href="javascript:void(0)" onclick="clearHistory()">Effacer l'historique</a>
    </div>

    <!-- Sélection de l'équipe, placé juste en dessous de la bannière -->
    <div id="teamSelectContainer">
        <label for="teamSelect">Sélectionnez l'équipe :</label>
        <select id="teamSelect">
            <option value="teamRed">Équipe Rouge</option>
            <option value="teamGreen">Équipe Vert</option>
            <option value="teamPurple">Équipe Violet</option>
        </select>
    </div>

    <!-- Roue avec l'indicateur à droite pour pointer le résultat -->
    <div id="wheel-container">
        <div id="wheel"></div>
        <div id="indicator"></div>
    </div>
    <button id="spinButton">Tourner</button>

    <!-- Dernière action affichée en grand -->
    <div class="last-action" id="lastAction">Dernière action : </div>

    <!-- Historique des équipes -->
    <div class="team-history">
        <div class="team" id="teamRed">
            <h3>Équipe Rouge</h3>
            <ul class="history" id="historyRed"></ul>
            <button onclick="showHistory('teamRed')">Afficher l'historique</button>
        </div>
        <div class="team" id="teamGreen">
            <h3>Équipe Vert</h3>
            <ul class="history" id="historyGreen"></ul>
            <button onclick="showHistory('teamGreen')">Afficher l'historique</button>
        </div>
        <div class="team" id="teamPurple">
            <h3>Équipe Violet</h3>
            <ul class="history" id="historyPurple"></ul>
            <button onclick="showHistory('teamPurple')">Afficher l'historique</button>
        </div>
    </div>

    <!-- Tableau des statistiques, réintégré sur la droite de la roue -->
    <div id="stats-table">
        <table>
            <tr>
                <th>Équipe</th>
                <th>Nombre de weeks</th>
                <th>Indices</th>
            </tr>
            <tr>
                <td>Équipe Rouge</td>
                <td id="weeksRed">0</td>
                <td id="indicesRed">0</td>
            </tr>
            <tr>
                <td>Équipe Vert</td>
                <td id="weeksGreen">0</td>
                <td id="indicesGreen">0</td>
            </tr>
            <tr>
                <td>Équipe Violet</td>
                <td id="weeksPurple">0</td>
                <td id="indicesPurple">0</td>
            </tr>
        </table>
    </div>

    <!-- Ajoutez Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    
    <script>
        // Configuration Supabase
        const supabaseUrl = 'https://kooskprneulkenvzbbyq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtvb2tzcHdybmV1bGtlbnZ6YmJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzE1NzM5NTcsImV4cCI6MjA0NzE0OTk1N30.NY3LXLr2QxpvqQjZ9IXy5AnNZXlzVBEMbwebY-0FQuY';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // Chargement de la bannière depuis Supabase
        async function loadBanner() {
            const { data, error } = await supabase
                .from('settings')
                .select('text')
                .eq('id', 'banner')
                .single();

            const bannerText = data ? data.text : "Bienvenue sur La roulette des secrets !";
            document.getElementById("bannerText").textContent = bannerText;

            if (bannerText.includes("{countdown}")) {
                const countdownTargetTime = getTargetTime();
                setInterval(() => updateCountdown(countdownTargetTime), 1000);
            }
        }

        // Récupère les statistiques de chaque équipe depuis Supabase
        async function loadTableValues() {
            const { data: teams, error } = await supabase
                .from('teams')
                .select('team_name, weeks, indices');
            
            teams.forEach(team => {
                document.getElementById(`weeks${team.team_name}`).textContent = team.weeks;
                document.getElementById(`indices${team.team_name}`).textContent = team.indices;
            });
        }

        function getTargetTime() {
            const targetHour = parseInt(localStorage.getItem("targetHour") || "18", 10);
            const targetMinute = parseInt(localStorage.getItem("targetMinute") || "0", 10);
            const targetSecond = parseInt(localStorage.getItem("targetSecond") || "0", 10);

            const now = new Date();
            const targetTime = new Date(now);
            targetTime.setHours(targetHour, targetMinute, targetSecond, 0);

            if (now > targetTime) {
                targetTime.setDate(targetTime.getDate() + 1);
            }
            return targetTime;
        }

        function updateCountdown(targetTime) {
            const now = new Date();
            const diff = targetTime - now;

            const hours = String(Math.floor((diff / (1000 * 60 * 60)) % 24)).padStart(2, '0');
            const minutes = String(Math.floor((diff / (1000 * 60)) % 60)).padStart(2, '0');
            const seconds = String(Math.floor((diff / 1000) % 60)).padStart(2, '0');

            const countdownText = `${hours}h ${minutes}m ${seconds}s`;
            document.getElementById("bannerText").textContent = localStorage.getItem("bannerText").replace("{countdown}", countdownText);
        }

        loadBanner();
        loadTableValues();

        function toggleAdminPopup() {
            const popup = document.getElementById("adminPopup");
            popup.style.display = popup.style.display === "none" || popup.style.display === "" ? "block" : "none";
        }

        async function clearHistory() {
            const { error } = await supabase
                .from('histories')
                .delete()
                .neq('id', null); // Supprime tous les enregistrements
            if (!error) alert("Historique effacé !");
        }
    </script>
</body>
</html>
